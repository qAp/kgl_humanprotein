---

title: `run.train`

keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/08_run.train.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/08_run.train.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>run on collie.local
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">reload_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combine-the-subsets'-meta-data">Combine the subsets' meta data<a class="anchor-link" href="#Combine-the-subsets'-meta-data"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="combine_subsets_metadata" class="doc_header"><code>combine_subsets_metadata</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L41" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>combine_subsets_metadata</code>(<strong><code>dir_data</code></strong>, <strong><code>n_subsets</code></strong>=<em><code>5</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dir_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../kgl_humanprotein_data&#39;</span><span class="p">)</span>
<span class="n">dir_mdata</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;mdata&#39;</span><span class="p">)</span>
<span class="n">n_subsets</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df_cells</span> <span class="o">=</span> <span class="n">combine_subsets_metadata</span><span class="p">(</span><span class="n">dir_data</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Processing subset 4...CPU times: user 28.5 ms, sys: 31.4 ms, total: 59.9 ms
Wall time: 123 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dir_mdata_raw</span> <span class="o">=</span> <span class="n">dir_mdata</span><span class="o">/</span><span class="s1">&#39;raw&#39;</span>
<span class="n">dir_mdata_raw</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df_cells</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">dir_mdata_raw</span><span class="o">/</span><span class="s1">&#39;train.feather&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">df_cells</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Filter-samples">Filter samples<a class="anchor-link" href="#Filter-samples"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cells</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">dir_mdata_raw</span><span class="o">/</span><span class="s1">&#39;train.feather&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cells</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_cells</span><span class="p">[</span><span class="n">df_cells</span><span class="p">[</span><span class="s1">&#39;Target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="cap_number_per_label" class="doc_header"><code>cap_number_per_label</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L57" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>cap_number_per_label</code>(<strong><code>df_cells</code></strong>, <strong><code>cap</code></strong>=<em><code>10000</code></em>, <strong><code>idx_start</code></strong>=<em><code>0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cells</span> <span class="o">=</span> <span class="n">cap_number_per_label</span><span class="p">(</span><span class="n">df_cells</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="mi">5_000</span><span class="p">,</span> <span class="n">idx_start</span><span class="o">=</span><span class="mi">5_000</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cells</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0     129
10     70
6      52
3      39
15     25
9      17
12     16
5      16
14     15
13     15
Name: Target, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cells</span><span class="p">[</span><span class="n">df_cells</span><span class="o">.</span><span class="n">Target</span> <span class="o">!=</span> <span class="s1">&#39;18&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>rle</th>
      <th>bbox</th>
      <th>Target</th>
      <th>max_green</th>
      <th>subset</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0877a7da-bba3-11e8-b2b9-ac1f6b6435d0_0</td>
      <td>{'counts': b'^1P5Pk1000000O1O1O01000O01O0001O1...</td>
      <td>[0, 0, 276, 206]</td>
      <td>3</td>
      <td>160</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0877a7da-bba3-11e8-b2b9-ac1f6b6435d0_1</td>
      <td>{'counts': b'PPV:1oo12N1O1O3M2N00001O000000000...</td>
      <td>[163, 0, 438, 325]</td>
      <td>3</td>
      <td>71</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0877a7da-bba3-11e8-b2b9-ac1f6b6435d0_2</td>
      <td>{'counts': b'nTdm0=co11O1O1O000000000O2O000O2N...</td>
      <td>[474, 0, 1250, 207]</td>
      <td>3</td>
      <td>255</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0877a7da-bba3-11e8-b2b9-ac1f6b6435d0_3</td>
      <td>{'counts': b'fUj[21no12N4L1O2N2N2N&gt;B2M3N5K3K4M...</td>
      <td>[1213, 0, 1766, 291]</td>
      <td>3</td>
      <td>255</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0877a7da-bba3-11e8-b2b9-ac1f6b6435d0_4</td>
      <td>{'counts': b'WXTf11no12O1N2N2O1O1N4L3M2O1N2N3L...</td>
      <td>[866, 147, 1494, 509]</td>
      <td>3</td>
      <td>255</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>389</th>
      <td>f8d60850-bbbe-11e8-b2ba-ac1f6b6435d0_10</td>
      <td>{'counts': b'[`_j02ko16L2N2L7L2N1O2M9H2N1N9H00...</td>
      <td>[423, 1190, 1138, 1802]</td>
      <td>14</td>
      <td>223</td>
      <td>4</td>
    </tr>
    <tr>
      <th>390</th>
      <td>f8d60850-bbbe-11e8-b2ba-ac1f6b6435d0_11</td>
      <td>{'counts': b'V[1\\&lt;dc100O1N2O1O1O1O10000O10000...</td>
      <td>[0, 1214, 390, 1778]</td>
      <td>14</td>
      <td>255</td>
      <td>4</td>
    </tr>
    <tr>
      <th>391</th>
      <td>f8d60850-bbbe-11e8-b2ba-ac1f6b6435d0_12</td>
      <td>{'counts': b'hge?`0_o12N2L6nMV2H2aUNPMkg1R3TXN...</td>
      <td>[250, 1458, 682, 2018]</td>
      <td>14</td>
      <td>255</td>
      <td>4</td>
    </tr>
    <tr>
      <th>392</th>
      <td>f8d60850-bbbe-11e8-b2ba-ac1f6b6435d0_13</td>
      <td>{'counts': b'^ceV1:fo11O1O3M3L2O1O3L3M2N2O1O2N...</td>
      <td>[618, 1642, 1210, 2048]</td>
      <td>14</td>
      <td>200</td>
      <td>4</td>
    </tr>
    <tr>
      <th>393</th>
      <td>f8d60850-bbbe-11e8-b2ba-ac1f6b6435d0_14</td>
      <td>{'counts': b'ni1R6ni10000000000000000000000000...</td>
      <td>[0, 1842, 261, 2048]</td>
      <td>14</td>
      <td>255</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
<p>394 rows Ã— 6 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_cells</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="n">dir_mdata_raw</span><span class="o">/</span><span class="s1">&#39;train.feather&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="One-hot-encode-labels">One-hot encode labels<a class="anchor-link" href="#One-hot-encode-labels"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In <em>bestfitting</em>'s code, this generates the "meta" files.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">generate_meta</span><span class="p">(</span><span class="n">dir_mdata</span><span class="p">,</span> <span class="s1">&#39;train.feather&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 103 ms, sys: 4.07 ms, total: 107 ms
Wall time: 113 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Split-generation">Split generation<a class="anchor-link" href="#Split-generation"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">train_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="n">dir_mdata</span><span class="o">/</span><span class="s1">&#39;meta&#39;</span><span class="o">/</span><span class="s1">&#39;train_meta.feather&#39;</span><span class="p">)</span>
<span class="n">create_random_split</span><span class="p">(</span><span class="n">dir_mdata</span><span class="p">,</span> <span class="n">train_meta</span><span class="p">,</span> <span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span>
<span class="k">del</span> <span class="n">train_meta</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Nucleoplasm 103 26
Nuclear membrane 0 0
Nucleoli 0 0
Nucleoli fibrillar center 31 8
Nuclear speckles 0 0
Nuclear bodies 13 3
Endoplasmic reticulum 42 10
Golgi apparatus 0 0
Intermediate filaments 0 0
Actin filaments 14 3
Microtubules 56 14
Mitotic spindle 0 0
Centrosome 12 4
Plasma membrane 12 3
Mitochondria 12 3
Aggresome 20 5
Cytosol 0 0
Vesicles and punctate cytosolic patterns 0 0
Negative 0 0
create split file: mdata/split/random_folds5/random_train_cv0.feather, shape: (315, 27)
create split file: mdata/split/random_folds5/random_valid_cv0.feather, shape: (79, 27)
create split file: mdata/split/random_folds5/random_train_cv1.feather, shape: (315, 27)
create split file: mdata/split/random_folds5/random_valid_cv1.feather, shape: (79, 27)
create split file: mdata/split/random_folds5/random_train_cv2.feather, shape: (316, 27)
create split file: mdata/split/random_folds5/random_valid_cv2.feather, shape: (78, 27)
create split file: mdata/split/random_folds5/random_train_cv3.feather, shape: (315, 27)
create split file: mdata/split/random_folds5/random_valid_cv3.feather, shape: (79, 27)
create split file: mdata/split/random_folds5/random_train_cv4.feather, shape: (315, 27)
create split file: mdata/split/random_folds5/random_valid_cv4.feather, shape: (79, 27)
CPU times: user 74.8 ms, sys: 16.4 ms, total: 91.1 ms
Wall time: 86.6 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Weighted-random-sampler">Weighted random sampler<a class="anchor-link" href="#Weighted-random-sampler"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_label_weights" class="doc_header"><code>get_label_weights</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L68" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_label_weights</code>(<strong><code>df</code></strong>)</p>
</blockquote>
<p>Weigh each label with the reciprocal of its probability of
appearance in the dataset.</p>
<p>Args:
    df (pd.DataFrame): Meta data data-frame.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_weighted_sampler</span><span class="p">():</span>
    <span class="n">dir_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../kgl_humanprotein_data/&#39;</span><span class="p">)</span>
    <span class="n">train_split_file</span> <span class="o">=</span> <span class="n">dir_mdata</span><span class="o">/</span><span class="s1">&#39;split&#39;</span><span class="o">/</span><span class="s1">&#39;random_folds5&#39;</span><span class="o">/</span><span class="s1">&#39;random_train_cv0.feather&#39;</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ProteinDataset</span><span class="p">(</span><span class="n">dir_data</span><span class="p">,</span> <span class="n">train_split_file</span><span class="p">)</span>

    <span class="n">label_weights</span> <span class="o">=</span> <span class="n">get_label_weights</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">split_df</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">split_df</span><span class="p">[</span><span class="s1">&#39;Target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">label_weights</span><span class="p">[</span><span class="n">o</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">WeightedRandomSampler</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">label_weights</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">split_df</span><span class="o">.</span><span class="n">Target</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>run on collie.local
run on collie.local
run on collie.local
run on collie.local
run on collie.local
run on collie.local
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Run-training">Run training<a class="anchor-link" href="#Run-training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="main_training" class="doc_header"><code>main_training</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L88" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>main_training</code>(<strong><code>dir_data</code></strong>, <strong><code>dir_mdata</code></strong>, <strong><code>dir_results</code></strong>, <strong><code>out_dir</code></strong>, <strong><code>gpu_id</code></strong>=<em><code>'0'</code></em>, <strong><code>arch</code></strong>=<em><code>'class_densenet121_dropout'</code></em>, <strong><code>model_multicell</code></strong>=<em><code>None</code></em>, <strong><code>num_classes</code></strong>=<em><code>19</code></em>, <strong><code>in_channels</code></strong>=<em><code>4</code></em>, <strong><code>loss</code></strong>=<em><code>'FocalSymmetricLovaszHardLogLoss'</code></em>, <strong><code>scheduler</code></strong>=<em><code>'Adam45'</code></em>, <strong><code>epochs</code></strong>=<em><code>55</code></em>, <strong><code>img_size</code></strong>=<em><code>768</code></em>, <strong><code>crop_size</code></strong>=<em><code>512</code></em>, <strong><code>batch_size</code></strong>=<em><code>32</code></em>, <strong><code>workers</code></strong>=<em><code>3</code></em>, <strong><code>pin_memory</code></strong>=<em><code>True</code></em>, <strong><code>split_name</code></strong>=<em><code>'random_ext_folds5'</code></em>, <strong><code>fold</code></strong>=<em><code>0</code></em>, <strong><code>clipnorm</code></strong>=<em><code>1</code></em>, <strong><code>resume</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>PyTorch Protein Classification.  Main training function.</p>
<p>Args:
    dir_data (str, Path): Directory where training subsets are.
    dir_mdata (str, Path): Directory where training meta data is.
    dir_results (std, Path): Directory to save training results.
    out_dir (str):
        Name/label for this training run.  Will be used to create
        directory under <code>dir_results</code>.
    gpu_id (str): GPU id used for training. Default: '0'
    arch (str): Model architecture.
        Default: <code>'class_densenet121_dropout'</code>
    model_multicell (Path, str): Path to multi-cell model
        to start training from. Default: None
    num_classes (int): Number of classes. Default: 19
    in_channels (int): In channels. Default: 4
    loss (str, optional): Loss function.
        One of <code>'FocalSymmetricLovaszHardLogLoss'</code>.
        Default: <code>'FocalSymmetricLovaszHardLogLoss'</code>
    scheduler (str): Scheduler name. Default: <code>'Adam45'</code>
    epochs (int): Number of total epochs to run. Default: 55
    img_size (int): Image size.  Default: 768
    crop_size (int): Crop size.  Default: 512
    batch_size (int): Train mini-batch size. Default: 32
    workers (int): Number of data loading workers. Default: 3
    pin_memory (bool): DataLoader's <code>pin_memory</code> argument.
    split_name (str, optional): Split name.
        One of: <code>'random_ext_folds5'</code>,
        or <code>'random_ext_noleak_clean_folds5'</code>.
        Default: <code>'random_ext_folds5'</code>
    fold (int): Index of fold. Default: 0
    clipnorm (int): Clip grad norm'. Default: 1
    resume (str): Name of the latest checkpoint. Default: None</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="train" class="doc_header"><code>train</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L286" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>train</code>(<strong><code>train_loader</code></strong>, <strong><code>model</code></strong>, <strong><code>criterion</code></strong>, <strong><code>optimizer</code></strong>, <strong><code>epoch</code></strong>, <strong><code>clipnorm</code></strong>=<em><code>1</code></em>, <strong><code>lr</code></strong>=<em><code>1e-05</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="validate" class="doc_header"><code>validate</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L335" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>validate</code>(<strong><code>valid_loader</code></strong>, <strong><code>model</code></strong>, <strong><code>criterion</code></strong>, <strong><code>epoch</code></strong>, <strong><code>focal_loss</code></strong>, <strong><code>threshold</code></strong>=<em><code>0.5</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="save_model" class="doc_header"><code>save_model</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L381" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>save_model</code>(<strong><code>model</code></strong>, <strong><code>is_best</code></strong>, <strong><code>model_out_dir</code></strong>, <strong><code>optimizer</code></strong>=<em><code>None</code></em>, <strong><code>epoch</code></strong>=<em><code>None</code></em>, <strong><code>best_epoch</code></strong>=<em><code>None</code></em>, <strong><code>best_focal</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="multi_class_acc" class="doc_header"><code>multi_class_acc</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L411" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>multi_class_acc</code>(<strong><code>preds</code></strong>, <strong><code>targs</code></strong>, <strong><code>th</code></strong>=<em><code>0.5</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AverageMeter" class="doc_header"><code>class</code> <code>AverageMeter</code><a href="https://github.com/qAp/kgl_humanprotein/tree/master/kgl_humanprotein/run/train.py#L416" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AverageMeter</code>()</p>
</blockquote>
<p>Computes and stores the average and current value</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dir_results</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
<span class="n">dir_results</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds&#39;</span><span class="p">)</span>
<span class="n">model_multicell</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;../../kgl_humanprotein_data/result/models/&#39;</span>
    <span class="s1">&#39;external_crop512_focal_slov_hardlog_class_densenet121_dropout_i768_aug2_5folds/&#39;</span>
    <span class="s1">&#39;fold0/final.pth&#39;</span><span class="p">)</span>
<span class="n">gpu_id</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="c1"># &#39;0,1,2,3&#39;</span>
<span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;class_densenet121_dropout&#39;</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">LABEL_NAME_LIST</span><span class="p">)</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="s1">&#39;Adam55&#39;</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#55</span>
<span class="n">resume</span> <span class="o">=</span> <span class="s1">&#39;001.pth&#39;</span>
<span class="n">sz_img</span> <span class="o">=</span> <span class="mi">384</span>
<span class="n">crop_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="c1">#512</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">split_name</span> <span class="o">=</span> <span class="s1">&#39;random_folds5&#39;</span>
<span class="n">fold</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">workers</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 3</span>
<span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">main_training</span><span class="p">(</span><span class="n">dir_data</span><span class="p">,</span> <span class="n">dir_mdata</span><span class="p">,</span> <span class="n">dir_results</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> 
              <span class="n">split_name</span><span class="o">=</span><span class="n">split_name</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="n">fold</span><span class="p">,</span>
              <span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span> <span class="n">model_multicell</span><span class="o">=</span><span class="n">model_multicell</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
              <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">,</span>
              <span class="n">img_size</span><span class="o">=</span><span class="n">sz_img</span><span class="p">,</span> <span class="n">crop_size</span><span class="o">=</span><span class="n">crop_size</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
              <span class="n">gpu_id</span><span class="o">=</span><span class="n">gpu_id</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>&gt;&gt; Creating directory if it does not exist:
&gt;&gt; &#39;results/models/external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds/fold0&#39;
&gt;&gt; Using pre-trained model.
&gt;&gt; Loading multi-cell model.
&gt;&gt; Loading checkpoint:
&gt;&gt; &#39;results/models/external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds/fold0/001.pth&#39;
&gt;&gt; Loading checkpoint:
&gt;&gt; &#39;results/models/external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds/fold0/001_optim.pth&#39;
&gt;&gt;&gt;&gt; loaded checkpoint:
&gt;&gt;&gt;&gt; &#39;results/models/external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds/fold0/001.pth&#39; (epoch 1)
** start training here! **

epoch    iter      rate     |  train_loss/acc  |    valid_loss/acc/focal/kaggle     |best_epoch/best_focal|  min 
-----------------------------------------------------------------------------------------------------------------
  2.0       9    0.000300   |  38.5619  0.5519  |    14.4570  0.6470 22.1923 0.1003    |     2.0    22.1923   | 0.4 min 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span> du -hs results/models/external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds/fold0/
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>362M	results/models/external_crop256_focal_slov_hardlog_class_densenet121_dropout_i384_aug2_5folds/fold0/
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

